<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Expressä»»åŠ¡ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body data-is-edit="<%= isEdit ? 'true' : 'false' %>" data-task-id="<%= task ? task.id : '' %>">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-check-square"></i>
                ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">ä»ªè¡¨ç›˜</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/tasks">æˆ‘çš„ä»»åŠ¡</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/tasks/new">åˆ›å»ºä»»åŠ¡</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about">å…³äº</a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            <%= currentUser.username %>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/settings">
                                <i class="bi bi-gear"></i> è®¾ç½®
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> é€€å‡ºç™»å½•
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="container mt-4">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">ä»ªè¡¨ç›˜</a></li>
                <li class="breadcrumb-item"><a href="/tasks">ä»»åŠ¡åˆ—è¡¨</a></li>
                <li class="breadcrumb-item active"><%= isEdit ? 'ç¼–è¾‘ä»»åŠ¡' : 'åˆ›å»ºä»»åŠ¡' %></li>
            </ol>
        </nav>

        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h2">
                    <% if (isEdit) { %>
                        <i class="bi bi-pencil"></i> ç¼–è¾‘ä»»åŠ¡
                    <% } else { %>
                        <i class="bi bi-plus-circle"></i> åˆ›å»ºæ–°ä»»åŠ¡
                    <% } %>
                </h1>
                <p class="text-muted">
                    <% if (isEdit) { %>
                        ä¿®æ”¹ä»»åŠ¡ä¿¡æ¯å’ŒçŠ¶æ€
                    <% } else { %>
                        æ·»åŠ æ–°çš„ä»»åŠ¡åˆ°æ‚¨çš„å¾…åŠåˆ—è¡¨
                    <% } %>
                </p>
            </div>
            <div class="col-auto">
                <a href="/tasks" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
                </a>
            </div>
        </div>

        <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤º -->
        <div id="alertContainer"></div>

        <!-- ä»»åŠ¡è¡¨å• -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <% if (isEdit) { %>
                                <i class="bi bi-pencil"></i> ç¼–è¾‘ä»»åŠ¡ä¿¡æ¯
                            <% } else { %>
                                <i class="bi bi-file-text"></i> ä»»åŠ¡è¯¦ç»†ä¿¡æ¯
                            <% } %>
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="taskForm" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="title" class="form-label">
                                            <i class="bi bi-card-heading"></i> ä»»åŠ¡æ ‡é¢˜ *
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="title" 
                                               name="title" 
                                               required 
                                               maxlength="255"
                                               placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜..."
                                               value="<%= task ? task.title : '' %>">
                                        <div class="invalid-feedback">
                                            è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜
                                        </div>
                                        <div class="form-text">
                                            ç®€æ´æ˜äº†åœ°æè¿°è¿™ä¸ªä»»åŠ¡ï¼ˆæœ€å¤š255ä¸ªå­—ç¬¦ï¼‰
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="priority" class="form-label">
                                            <i class="bi bi-flag"></i> ä¼˜å…ˆçº§
                                        </label>
                                        <select class="form-select" id="priority" name="priority">
                                            <option value="low" <%= task && task.priority === 'low' ? 'selected' : '' %>>
                                                ğŸ”µ ä½ä¼˜å…ˆçº§
                                            </option>
                                            <option value="medium" <%= task && task.priority === 'medium' ? 'selected' : (!task ? 'selected' : '') %>>
                                                ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
                                            </option>
                                            <option value="high" <%= task && task.priority === 'high' ? 'selected' : '' %>>
                                                ğŸ”´ é«˜ä¼˜å…ˆçº§
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="status" class="form-label">
                                            <i class="bi bi-clock-history"></i> ä»»åŠ¡çŠ¶æ€
                                        </label>
                                        <select class="form-select" id="status" name="status">
                                            <option value="pending" <%= task && task.status === 'pending' ? 'selected' : (!task ? 'selected' : '') %>>
                                                ğŸ“‹ å¾…å¼€å§‹
                                            </option>
                                            <option value="in_progress" <%= task && task.status === 'in_progress' ? 'selected' : '' %>>
                                                â³ è¿›è¡Œä¸­
                                            </option>
                                            <option value="completed" <%= task && task.status === 'completed' ? 'selected' : '' %>>
                                                âœ… å·²å®Œæˆ
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="due_date" class="form-label">
                                            <i class="bi bi-calendar-date"></i> æˆªæ­¢æ—¥æœŸ
                                        </label>
                                        <input type="datetime-local" 
                                               class="form-control" 
                                               id="due_date" 
                                               name="due_date"
                                               value="<%= task && task.due_date ? new Date(task.due_date).toISOString().slice(0, 16) : '' %>">
                                        <div class="form-text">
                                            é€‰æ‹©ä»»åŠ¡çš„æˆªæ­¢æ—¶é—´ï¼ˆå¯é€‰ï¼‰
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">
                                    <i class="bi bi-card-text"></i> ä»»åŠ¡æè¿°
                                </label>
                                <textarea class="form-control" 
                                          id="description" 
                                          name="description" 
                                          rows="4" 
                                          placeholder="è¯¦ç»†æè¿°è¿™ä¸ªä»»åŠ¡çš„å†…å®¹ã€è¦æ±‚ã€æ³¨æ„äº‹é¡¹ç­‰..."><%= task ? task.description || '' : '' %></textarea>
                                <div class="form-text">
                                    æä¾›ä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¸®åŠ©æ‚¨æ›´å¥½åœ°ç†è§£å’Œæ‰§è¡Œä»»åŠ¡
                                </div>
                            </div>

                            <!-- æäº¤æŒ‰é’® -->
                            <div class="d-flex justify-content-between">
                                <div>
                                    <% if (isEdit) { %>
                                        <button type="button" class="btn btn-danger" onclick="deleteTask()">
                                            <i class="bi bi-trash"></i> åˆ é™¤ä»»åŠ¡
                                        </button>
                                    <% } %>
                                </div>
                                <div>
                                    <a href="/tasks" class="btn btn-secondary me-2">
                                        <i class="bi bi-x-circle"></i> å–æ¶ˆ
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <% if (isEdit) { %>
                                            <i class="bi bi-check-circle"></i> ä¿å­˜ä¿®æ”¹
                                        <% } else { %>
                                            <i class="bi bi-plus-circle"></i> åˆ›å»ºä»»åŠ¡
                                        <% } %>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- æç¤ºä¿¡æ¯å¡ç‰‡ -->
                <div class="card mt-4 bg-light">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-lightbulb"></i> ä»»åŠ¡ç®¡ç†å°è´´å£«
                        </h6>
                        <ul class="small text-muted mb-0">
                            <li>ä½¿ç”¨æ¸…æ™°ç®€æ´çš„æ ‡é¢˜æ¥æè¿°ä»»åŠ¡ç›®æ ‡</li>
                            <li>æ ¹æ®ä»»åŠ¡çš„é‡è¦æ€§å’Œç´§æ€¥ç¨‹åº¦è®¾ç½®åˆé€‚çš„ä¼˜å…ˆçº§</li>
                            <li>åœ¨æè¿°ä¸­åŒ…å«ä»»åŠ¡çš„å…·ä½“è¦æ±‚å’ŒéªŒæ”¶æ ‡å‡†</li>
                            <li>è®¾ç½®åˆç†çš„æˆªæ­¢æ—¥æœŸæœ‰åŠ©äºæé«˜æ‰§è¡Œæ•ˆç‡</li>
                            <li>åŠæ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€ä»¥è·Ÿè¸ªè¿›åº¦</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>Expressä»»åŠ¡ç®¡ç†ç³»ç»Ÿ</h6>
                    <p class="text-muted small">
                        åŸºäºNode.jså’ŒExpressæ¡†æ¶æ„å»ºçš„å…¨æ ˆä»»åŠ¡ç®¡ç†åº”ç”¨
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="text-muted small">
                        æŠ€æœ¯æ ˆ: Express.js, SQLite, EJS, Bootstrap
                    </p>
                    <p class="text-muted small">
                        Â© 2024 Expresså­¦ä¹ é¡¹ç›®
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- è‡ªå®šä¹‰JavaScript -->
    <script src="/js/app.js"></script>
    
    <script>
        // ä»HTMLæ•°æ®å±æ€§ä¸­è·å–å˜é‡
        const isEdit = document.body.dataset.isEdit === 'true';
        const taskId = document.body.dataset.taskId ? parseInt(document.body.dataset.taskId) : null;

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>å¤„ç†ä¸­...';
            submitBtn.disabled = true;

            try {
                const formData = new FormData(this);
                const taskData = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    status: formData.get('status'),
                    priority: formData.get('priority'),
                    due_date: formData.get('due_date') || null
                };

                const url = isEdit ? `/api/tasks/${taskId}` : '/api/tasks';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();

                if (result.success) {
                    Utils.showAlert(
                        isEdit ? 'ä»»åŠ¡æ›´æ–°æˆåŠŸï¼' : 'ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼', 
                        'success', 
                        2000
                    );
                    
                    // å»¶è¿Ÿè·³è½¬
                    setTimeout(() => {
                        if (isEdit) {
                            window.location.href = `/tasks/${taskId}`;
                        } else {
                            window.location.href = '/tasks';
                        }
                    }, 1000);
                } else {
                    Utils.showAlert(
                        'æ“ä½œå¤±è´¥: ' + (result.errors ? result.errors.join(', ') : result.error), 
                        'danger'
                    );
                }
            } catch (error) {
                console.error('æäº¤é”™è¯¯:', error);
                Utils.showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask() {
            if (!taskId) return;

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    Utils.showAlert('ä»»åŠ¡å·²åˆ é™¤', 'success', 2000);
                    setTimeout(() => {
                        window.location.href = '/tasks';
                    }, 1000);
                } else {
                    Utils.showAlert('åˆ é™¤å¤±è´¥: ' + result.error, 'danger');
                }
            } catch (error) {
                console.error('åˆ é™¤é”™è¯¯:', error);
                Utils.showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåèšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('title').focus();
            
            // ç¦ç”¨è¡¨å•çš„é»˜è®¤HTML5éªŒè¯æ ·å¼
            const forms = document.querySelectorAll('.needs-validation');
            forms.forEach(form => {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                });
            });
        });

        // å­—ç¬¦è®¡æ•°å™¨
        const titleInput = document.getElementById('title');
        titleInput.addEventListener('input', function() {
            const length = this.value.length;
            const maxLength = this.getAttribute('maxlength');
            
            if (length > maxLength * 0.8) {
                this.classList.add('text-warning');
            } else {
                this.classList.remove('text-warning');
            }
        });
    </script>
</body>
</html>
